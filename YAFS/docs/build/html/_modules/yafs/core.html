
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>yafs.core &#8212; YAFS 0.3 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for yafs.core</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module unifies the event-discrete simulation environment with the rest of modules: placement, topology, selection, population, utils and metrics.</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">simpy</span>
<span class="kn">import</span> <span class="nn">scipy.spatial</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>

<span class="kn">from</span> <span class="nn">yafs.topology</span> <span class="k">import</span> <span class="n">Topology</span>
<span class="kn">from</span> <span class="nn">yafs.application</span> <span class="k">import</span> <span class="n">Application</span>
<span class="kn">from</span> <span class="nn">yafs.metrics</span> <span class="k">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">yafs.distribution</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">yafs</span> <span class="k">import</span> <span class="n">utils</span>

<span class="kn">from</span> <span class="nn">trackanimation.animation</span> <span class="k">import</span> <span class="n">AnimationTrack</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">smopy</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span> <span class="k">as</span> <span class="n">pimg</span>

<span class="n">EVENT_UP_ENTITY</span> <span class="o">=</span> <span class="s2">&quot;node_up&quot;</span>
<span class="n">EVENT_DOWN_ENTITY</span> <span class="o">=</span> <span class="s2">&quot;node_down&quot;</span>

<span class="n">NETWORK_LIMIT</span> <span class="o">=</span> <span class="mi">100000000</span>

<div class="viewcode-block" id="Sim"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim">[docs]</a><span class="k">class</span> <span class="nc">Sim</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    This class contains the cloud event-discrete simulation environment and it controls the structure variables.</span>


<span class="sd">    Args:</span>
<span class="sd">       topology (object) - the associate (:mod:`Topology`) of the environment. There is only one.</span>

<span class="sd">    Kwargs:</span>
<span class="sd">       name_register (str): database file name where are registered the events.</span>

<span class="sd">       purge_register (boolean): True - clean the database</span>

<span class="sd">       logger (logger) - logger</span>


<span class="sd">    **Main variables to coordinate with algorithm:**</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NODE_METRIC</span> <span class="o">=</span> <span class="s2">&quot;COMP_M&quot;</span>
    <span class="n">SOURCE_METRIC</span> <span class="o">=</span> <span class="s2">&quot;SRC_M&quot;</span>
    <span class="n">FORWARD_METRIC</span> <span class="o">=</span> <span class="s2">&quot;FWD_M&quot;</span>
    <span class="n">SINK_METRIC</span> <span class="o">=</span> <span class="s2">&quot;SINK_M&quot;</span>
    <span class="n">LINK_METRIC</span> <span class="o">=</span> <span class="s2">&quot;LINK&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">name_register</span><span class="o">=</span><span class="s1">&#39;events_log.json&#39;</span><span class="p">,</span> <span class="n">link_register</span><span class="o">=</span><span class="s1">&#39;links_log.json&#39;</span><span class="p">,</span> <span class="n">redis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">purge_register</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_results_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        the discrete-event simulator (aka DES)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__idProcess</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># an unique indentifier for each process in the DES</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__idMessage</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># an unique indentifier for each message</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">network_ctrl_pipe</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_pump</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># a shared resource that control the exchange of messagess in the topology</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Any algorithm can stop internally the simulation putting these value to True. By default is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">until</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#End time simulation</span>
        <span class="c1">#self.db = TinyDB(name_register)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">default_results_path</span><span class="o">=</span><span class="n">default_results_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unreachabled_links</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="s2">&quot;Contains the database where all events are recorded&quot;</span>



        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear the database</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">entity_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__init_metrics</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Current consumed metrics of each element topology: Nodes &amp; Edges</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">placement_policy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># for app.name the placement algorithm</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">population_policy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># for app.name the population algorithm</span>

        <span class="c1"># for app.nmae</span>
        <span class="c1"># self.process_topology = {}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Start/stop flag for each pure source</span>
        <span class="c1"># key: id.source.process</span>
        <span class="c1"># value: Boolean</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">des_control_process</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># key: app.name</span>
        <span class="c1"># value: des process</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_source</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Relationship of pure source with topology entity</span>

<span class="sd">        id.source.process -&gt; value: dict(&quot;id&quot;,&quot;app&quot;,&quot;module&quot;)</span>

<span class="sd">          .. code-block:: python</span>

<span class="sd">            alloc_source[34] = {&quot;id&quot;:id_node,&quot;app&quot;:app_name,&quot;module&quot;:source module}</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">consumer_pipes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Queues for each message</span>
        <span class="c1"># App+module+idDES -&gt; pipe</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents the deployment of a module in a DES PROCESS each DES has a one topology.node.id (see alloc_des var.)</span>

<span class="sd">        It used for (:mod:`Placement`) class interaction.</span>

<span class="sd">        A dictionary where the key is an app.name and value is a dictionary with key is a module and value an array of id DES process</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {&quot;EGG_GAME&quot;:{&quot;Controller&quot;:[1,3,4],&quot;Client&quot;:[4]}}</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The relationship between DES process and topology.node.id</span>

<span class="sd">        It is necessary to identify the message.source (topology.node)</span>
<span class="sd">        1.N. DES process -&gt; 1. topology.node</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">selector_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Store for each app.name the selection policy</span>
        <span class="c1"># app.name -&gt; Selector</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_busy_time</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># must be updated with up/down nodes</span>
        <span class="c1"># This variable control the lag of each busy network links. It avoids the generation of a DES-process for each link</span>
        <span class="c1"># edge -&gt; last_use_channel (float) = Simulation time</span>




        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        MOBILE ADAPTATIONS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_coverage</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.0001</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tracks</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#v2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tracks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_movement_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># self.__send_message(app_name, message, idDES, self.SOURCE_METRIC)</span>
    <span class="k">def</span> <span class="nf">__send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">idDES</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Any exchange of messages between modules is done with this function and updates the metrics when the message achieves the destination module</span>

<span class="sd">        Args:</span>
<span class="sd">            app_name (string)º</span>

<span class="sd">            message: (:mod:`Message`)</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            id_src (int) identifier of a pure source module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO IMPROVE asignation of topo = alloc_DES(IdDES) , It has to move to the get_path process</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">paths</span><span class="p">,</span><span class="n">DES_dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector_path</span><span class="p">[</span><span class="n">app_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">app_name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">idDES</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_busy_time</span><span class="p">,</span><span class="n">from_des</span><span class="o">=</span><span class="n">idDES</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">DES_dst</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="ow">or</span> <span class="n">DES_dst</span><span class="o">==</span><span class="p">[[]]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;(#DES:</span><span class="si">%i</span><span class="s2">)</span><span class="se">\t</span><span class="s2">--- Unreacheable DST:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">: PATH:</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idDES</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">paths</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="s2">&quot;Debug&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;From __send_message function: &quot;</span><span class="p">)</span>
                    <span class="c1"># self.print_debug_assignaments()</span>
                    <span class="c1"># print &quot;NODES (%i): %s&quot;%(len(self.topology.G.nodes()),self.topology.G.nodes())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;NODES (</span><span class="si">%i</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_movement_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STEP : &quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">control_movement_class</span><span class="o">.</span><span class="n">current_step</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(#DES:</span><span class="si">%i</span><span class="s2">)</span><span class="se">\t</span><span class="s2">--- SENDING Message:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">: PATH:</span><span class="si">%s</span><span class="s2">  DES:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idDES</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">paths</span><span class="p">,</span><span class="n">DES_dst</span><span class="p">))</span>

                <span class="c1"># print &quot;MESSAGES&quot;</span>
                <span class="c1">#May be, the selector of path decides broadcasting multiples paths</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">app_name</span> <span class="o">=</span> <span class="n">app_name</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">idDES</span> <span class="o">=</span> <span class="n">DES_dst</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">network_ctrl_pipe</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;(#DES:</span><span class="si">%i</span><span class="s2">)</span><span class="se">\t</span><span class="s2">--- Unreacheable DST:</span><span class="se">\t</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idDES</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__network_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is an internal DES-process who manages the latency of messages sent in the network.</span>
<span class="sd">        Performs the simulation of packages within the path between src and dst entities decided by the selection algorithm.</span>
<span class="sd">        In this way, the message has a transmission latency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_edges</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_busy_time</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict(zip(edges, [0.0] * len(edges)))</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">network_ctrl_pipe</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="c1"># print &quot;NetworkProcess --- Current time %d &quot; %self.env.now</span>
            <span class="c1"># print &quot;name &quot; + message.name</span>
            <span class="c1"># print &quot;Path:&quot;,message.path</span>
            <span class="c1"># print &quot;DST_INT:&quot;,message.dst_int</span>
            <span class="c1"># #print message.timestamp</span>
            <span class="c1"># print &quot;DST&quot;,message.dst</span>


            <span class="c1"># If same SRC and PATH or the message has achieved the penultimate node to reach the dst</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="n">message</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">message</span><span class="o">.</span><span class="n">dst_int</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>

                <span class="n">pipe_id</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s%i</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span><span class="n">message</span><span class="o">.</span><span class="n">dst</span><span class="p">,</span><span class="n">message</span><span class="o">.</span><span class="n">idDES</span><span class="p">)</span>  <span class="c1"># app_name + module_name (dst) + idDES</span>
                <span class="c1"># Timestamp reception message in the module</span>
                <span class="n">message</span><span class="o">.</span><span class="n">timestamp_rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                <span class="c1"># The message is sent to the module.pipe</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consumer_pipes</span><span class="p">[</span><span class="n">pipe_id</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># The message is sent at first time or it sent more times.</span>
                <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">dst_int</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">src_int</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">message</span><span class="o">.</span><span class="n">dst_int</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">src_int</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">dst_int</span>
                    <span class="n">message</span><span class="o">.</span><span class="n">dst_int</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">dst_int</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="c1"># arista set by (src_int,message.dst_int)</span>
                <span class="n">link</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_int</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">dst_int</span><span class="p">)</span>


                <span class="c1"># Links in the topology are bidirectional: (a,b) == (b,a)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">last_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_busy_time</span><span class="p">[</span><span class="n">link</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">last_used</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="c1"># self.last_busy_time[link] = last_used</span>

                    <span class="c1">#link = (message.dst_int, src_int)</span>
                    <span class="c1">#last_used = self.last_busy_time[link]</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Computing message latency</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">size_bits</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">bytes</span>
                <span class="c1">#size_bits = message.bytes * 8</span>
                <span class="k">try</span><span class="p">:</span>
                   <span class="c1"># transmit = size_bits / (self.topology.get_edge(link)[Topology.LINK_BW] * 1000000.0)  # MBITS!</span>
                    <span class="n">transmit</span> <span class="o">=</span> <span class="n">size_bits</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">link</span><span class="p">)[</span><span class="n">Topology</span><span class="o">.</span><span class="n">LINK_BW</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000000.0</span><span class="p">)</span>  <span class="c1"># MBITS!</span>
                    <span class="n">propagation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">link</span><span class="p">)[</span><span class="n">Topology</span><span class="o">.</span><span class="n">LINK_PR</span><span class="p">]</span>
                    <span class="n">latency_msg_link</span> <span class="o">=</span> <span class="n">transmit</span> <span class="o">+</span> <span class="n">propagation</span>

                    <span class="c1">#print &quot;-link: %s -- lat: %d&quot; %(link,latency_msg_link)</span>

                    <span class="c1"># update link metrics</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">insert_link</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">LINK_METRIC</span><span class="p">,</span><span class="s2">&quot;src&quot;</span><span class="p">:</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s2">&quot;dst&quot;</span><span class="p">:</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s2">&quot;app&quot;</span><span class="p">:</span><span class="n">message</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span><span class="s2">&quot;latency&quot;</span><span class="p">:</span><span class="n">latency_msg_link</span><span class="p">,</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s2">&quot;ctime&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="n">message</span><span class="o">.</span><span class="n">bytes</span><span class="p">,</span><span class="s2">&quot;buffer&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">network_pump</span><span class="p">})</span><span class="c1">#&quot;path&quot;:message.path})</span>

                    <span class="c1"># We compute the future latency considering the current utilization of the link</span>
                    <span class="k">if</span> <span class="n">last_used</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">:</span>
                        <span class="n">shift_time</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">last_used</span> <span class="o">=</span> <span class="n">latency_msg_link</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>  <span class="c1"># future arrival time</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shift_time</span> <span class="o">=</span> <span class="n">last_used</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                        <span class="n">last_used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">shift_time</span> <span class="o">+</span> <span class="n">latency_msg_link</span>

                    <span class="c1"># print &quot;Send next WakeUp : &quot;, last_used</span>
                    <span class="c1"># print &quot;-&quot; * 30</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">last_busy_time</span><span class="p">[</span><span class="n">link</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_used</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__wait_message</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">latency_msg_link</span><span class="p">,</span> <span class="n">shift_time</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1">#This fact is produced when a node or edge the topology is changed or disappeared</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The initial path assigned is unreachabled. Link: (</span><span class="si">%i</span><span class="s2">,</span><span class="si">%i</span><span class="s2">). Routing a new one. </span><span class="si">%i</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">link</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">))</span>

                    <span class="n">paths</span><span class="p">,</span> <span class="n">DES_dst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selector_path</span><span class="p">[</span><span class="n">message</span><span class="o">.</span><span class="n">app_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_path_from_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_busy_time</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span><span class="n">from_des</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">idDES</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">DES_dst</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">paths</span><span class="o">==</span><span class="p">[]:</span>
                        <span class="c1">#Message communication ending:</span>
                        <span class="c1">#The message have arrived to the destination node but it is unavailable.</span>
                        <span class="kc">None</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> No path given. Message is lost&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>

                        <span class="n">message</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">message</span><span class="o">.</span><span class="n">idDES</span> <span class="o">=</span> <span class="n">DES_dst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(</span><span class="se">\t</span><span class="s2"> New path given. Message is enrouting again.&quot;</span><span class="p">)</span>
                        <span class="c1"># print &quot;\t&quot;,msg.path</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">network_ctrl_pipe</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">__wait_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">shift_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulates the transfer behavior of a message on a link</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_pump</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">latency</span> <span class="o">+</span> <span class="n">shift_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_pump</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_ctrl_pipe</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_id_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A DES-process has an unique identifier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__idProcess</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__idProcess</span>

    <span class="k">def</span> <span class="nf">__init_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Each entity and node metrics are initialized with empty values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodes_att</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_nodes_att</span><span class="p">()</span>
        <span class="n">measures</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">nodes_att</span><span class="p">:</span>
            <span class="n">measures</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_edges</span><span class="p">():</span>
            <span class="n">measures</span><span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">][</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">Topology</span><span class="o">.</span><span class="n">LINK_PR</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">LINK_PR</span><span class="p">],</span>
                                      <span class="n">Topology</span><span class="o">.</span><span class="n">LINK_BW</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">get_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">LINK_BW</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">measures</span>

    <span class="k">def</span> <span class="nf">__add_placement_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placement</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A DES-process who controls the invocation of Placement.run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">myId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">myId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_control_process</span><span class="p">[</span><span class="n">placement</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">myId</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added_Process - Placement Algorithm</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">myId</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">myId</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">placement</span><span class="o">.</span><span class="n">get_next_activation</span><span class="p">())</span>
            <span class="n">placement</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(DES:</span><span class="si">%i</span><span class="s2">) </span><span class="si">%7.4f</span><span class="s2"> Run - Placement Policy: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>  <span class="c1"># Rewrite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOP_Process - Placement Algorithm</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">myId</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add_population_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A DES-process who controls the invocation of Population.run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">myId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">myId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_control_process</span><span class="p">[</span><span class="n">population</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">myId</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added_Process - Population Algorithm</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">myId</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">myId</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">population</span><span class="o">.</span><span class="n">get_next_activation</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(DES:</span><span class="si">%i</span><span class="s2">) </span><span class="si">%7.4f</span><span class="s2"> Run - Population Policy: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>  <span class="c1"># REWRITE</span>
            <span class="n">population</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOP_Process - Population Algorithm</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">myId</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getIDMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__idMessage</span> <span class="o">+=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__idMessage</span>

    <span class="k">def</span> <span class="nf">__add_source_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idDES</span><span class="p">,</span> <span class="n">name_app</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">distribution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A DES-process who controls the invocation of several Pure Source Modules</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added_Process - Module Pure Source</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">idDES</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">idDES</span><span class="p">]:</span>
            <span class="n">nextTime</span> <span class="o">=</span> <span class="n">distribution</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">nextTime</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">idDES</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(App:</span><span class="si">%s</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">)</span><span class="se">\t</span><span class="s2">Module - Generating Message: </span><span class="si">%s</span><span class="s2"> </span><span class="se">\t</span><span class="s2">(T:</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name_app</span><span class="p">,</span> <span class="n">idDES</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">))</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__getIDMessage</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">__send_message</span><span class="p">(</span><span class="n">name_app</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">idDES</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SOURCE_METRIC</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOP_Process - Module Pure Source</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">idDES</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__update_node_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">des</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            It computes the service time in processing a message and record this event</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">[</span><span class="n">app</span><span class="p">]</span><span class="o">.</span><span class="n">get_sink_modules</span><span class="p">():</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                The module is a SINK (Actuactor)</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">id_node</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">des</span><span class="p">]</span>
                <span class="n">time_service</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                The module is a processing module</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">id_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">des</span><span class="p">]</span>

                <span class="c1"># att_node = self.topology.get_nodes_att()[id_node] # WARNING DEPRECATED from V1.0</span>
                <span class="n">att_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">id_node</span><span class="p">]</span>

                <span class="n">time_service</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">inst</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">att_node</span><span class="p">[</span><span class="s2">&quot;IPT&quot;</span><span class="p">])</span>


            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            it records the entity.id who sends this message</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># if not message.path:</span>
            <span class="c1">#     from_id_source = id_node  # same src like dst</span>
            <span class="c1"># else:</span>
            <span class="c1">#     from_id_source = message.path[0]</span>
            <span class="c1">#</span>
     <span class="c1"># # if message.id == 1072:</span>
     <span class="c1">#        print &quot;-&quot;*50</span>
     <span class="c1">#        print &quot;Module: &quot;,module # module that receives the request (RtR)</span>
     <span class="c1">#        print &quot;DES &quot;,des # DES process who RtR</span>
     <span class="c1">#        print &quot;ID MODULE: &quot;,id_node  #Topology entity who RtR</span>
     <span class="c1">#        print &quot;Message.name &quot;,message.name # Message name</span>
     <span class="c1">#        print &quot;Message.id &quot;, message.id #Message generator id</span>
     <span class="c1">#        print &quot;Message.path &quot;,message.path #enrouting path</span>
     <span class="c1">#        print &quot;Message src &quot;,message.src #module source who send the request</span>
     <span class="c1">#        print &quot;Message dst &quot;,message.dst #module dst (the entity that RtR)</span>
     <span class="c1">#        print &quot;Message idDEs &quot;,message.idDES #DES intermediate process that process the request</span>
     <span class="c1">#        print &quot;TOPO.src &quot;, message.path[0] #entity that RtR</span>
     <span class="c1">#        print &quot;TOPO.dst &quot;, int(self.alloc_DES[des]) #DES process that RtR</span>
     <span class="c1">#        print &quot;time service &quot;,time_service</span>
     <span class="c1">#        exit()</span>

     <span class="c1">#</span>
            <span class="c1"># # print &quot;MODULE: &quot;,self.alloc_module[app][module]</span>
            <span class="c1"># # tmp = []</span>
            <span class="c1"># # for it in self.alloc_module[app][module]:</span>
            <span class="c1"># #     tmp.append(self.alloc_DES[it])</span>
            <span class="c1"># # print &quot;ALLOC:  &quot;, tmp</span>
            <span class="c1"># # print &quot;PATH 0: &quot; ,message.path[0]</span>



            <span class="c1">#WARNING. If there are more than two equal modules deployed in the same entity, it will not be possible to determine which process sent this package at this point. That information will have to be calculated by the trace of the message (message.id)</span>
            <span class="n">sourceDES</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">DES_possible</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">message</span><span class="o">.</span><span class="n">src</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">eDES</span> <span class="ow">in</span> <span class="n">DES_possible</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">eDES</span><span class="p">]</span> <span class="o">==</span> <span class="n">message</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">sourceDES</span> <span class="o">=</span> <span class="n">eDES</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_source</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_source</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">message</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">sourceDES</span> <span class="o">=</span> <span class="n">k</span>

            <span class="c1"># print &quot;Source DES &quot;,sourceDES</span>
            <span class="c1"># print &quot;-&quot; * 50</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">:</span> <span class="n">app</span><span class="p">,</span> <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">module</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                 <span class="s2">&quot;DES.src&quot;</span><span class="p">:</span> <span class="n">sourceDES</span><span class="p">,</span> <span class="s2">&quot;DES.dst&quot;</span><span class="p">:</span><span class="n">des</span><span class="p">,</span><span class="s2">&quot;module.src&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">src</span><span class="p">,</span>
                 <span class="s2">&quot;TOPO.src&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;TOPO.dst&quot;</span><span class="p">:</span> <span class="n">id_node</span><span class="p">,</span>

                 <span class="s2">&quot;service&quot;</span><span class="p">:</span> <span class="n">time_service</span><span class="p">,</span> <span class="s2">&quot;time_in&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
                 <span class="s2">&quot;time_out&quot;</span><span class="p">:</span> <span class="n">time_service</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="s2">&quot;time_emit&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">timestamp</span><span class="p">),</span>
                 <span class="s2">&quot;time_reception&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">timestamp_rec</span><span class="p">)</span>

                 <span class="p">})</span>

            <span class="k">return</span> <span class="n">time_service</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># The node can be removed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Make sure that this node has been removed or it has all mandatory attributes - Node: DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">des</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>


        <span class="c1"># self.logger.debug(&quot;TS[%s] - DES: %i - %d&quot;%(module,des,time_service))</span>
        <span class="c1"># except:</span>
        <span class="c1">#     self.logger.warning(&quot;This module has been removed previously to the arrival time of this message. DES: %i&quot;%des)</span>
        <span class="c1">#     return 0</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MEJORAR - ASOCIAR UN PROCESO QUE LOS CONTROLES®.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__add_up_node_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_event</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">):</span>
        <span class="n">myId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added_Process - UP entity Creation</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">myId</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
            <span class="c1"># TODO Define function to ADD a new NODE in topology</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">next_event</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(DES:</span><span class="si">%i</span><span class="s2">) </span><span class="si">%7.4f</span><span class="s2"> Node &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOP_Process - UP entity Creation</span><span class="se">\t</span><span class="s2">#DES</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">myId</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MEJORAR - ASOCIAR UN PROCESO QUE LOS CONTROLES.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__add_down_node_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_event</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">):</span>
        <span class="n">myId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">myId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added_Process - Down entity Creation</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">myId</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">myId</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">next_event</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(DES:</span><span class="si">%i</span><span class="s2">) </span><span class="si">%7.4f</span><span class="s2"> Node &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myId</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOP_Process - Down entity Creation</span><span class="se">\t</span><span class="s2">#DES</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">myId</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add_source_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idDES</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">distribution</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It generates a DES process associated to a compute module for the generation of messages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added_Process - Module Source: </span><span class="si">%s</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">idDES</span><span class="p">))</span>
        <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">idDES</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">distribution</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">idDES</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;(App:</span><span class="si">%s</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">#</span><span class="si">%s</span><span class="s2">)</span><span class="se">\t</span><span class="s2">Module - Generating Message:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">idDES</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__send_message</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">idDES</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">SOURCE_METRIC</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOP_Process - Module Source: </span><span class="si">%s</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">idDES</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__add_consumer_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">register_consumer_msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It generates a DES process associated to a compute module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added_Process - Module Consumer: </span><span class="si">%s</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ides</span><span class="p">))</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">ides</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">ides</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer_pipes</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s%s%i</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span><span class="n">module</span><span class="p">,</span><span class="n">ides</span><span class="p">)]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="c1"># One pipe for each module name</span>

                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">[</span><span class="n">app_name</span><span class="p">]</span><span class="o">.</span><span class="n">services</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>

                <span class="c1"># for ser in m:</span>
                <span class="c1">#     if &quot;message_in&quot; in ser.keys():</span>
                <span class="c1">#         try:</span>
                <span class="c1">#             print &quot;\t\t M_In: %s  -&gt; M_Out: %s &quot; % (ser[&quot;message_in&quot;].name, ser[&quot;message_out&quot;].name)</span>
                <span class="c1">#         except:</span>
                <span class="c1">#             print &quot;\t\t M_In: %s  -&gt; M_Out: [NOTHING] &quot; % (ser[&quot;message_in&quot;].name)</span>

                <span class="c1"># print &quot;Registers len: %i&quot; %len(register_consumer_msg)</span>
                <span class="n">doBefore</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">register</span> <span class="ow">in</span> <span class="n">register_consumer_msg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">register</span><span class="p">[</span><span class="s2">&quot;message_in&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                        <span class="c1"># The message can be treated by this module</span>
                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        Processing the message</span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="c1"># if ides == 3:</span>
                        <span class="c1">#     print &quot;Consumer Message: %d &quot; % self.env.now</span>
                        <span class="c1">#     print &quot;MODULE DES: &quot;,ides</span>
                        <span class="c1">#     print &quot;id &quot;,msg.id</span>
                        <span class="c1">#     print &quot;name &quot;,msg.name</span>
                        <span class="c1">#     print msg.path</span>
                        <span class="c1">#     print msg.dst_int</span>
                        <span class="c1">#     print msg.timestamp</span>
                        <span class="c1">#     print msg.dst</span>
                        <span class="c1">#</span>
                        <span class="c1">#     print &quot;-&quot; * 30</span>

                        <span class="c1">#The module only computes this type of message one time.</span>
                        <span class="c1">#It records once</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">doBefore</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;(App:</span><span class="si">%s</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">#</span><span class="si">%s</span><span class="s2">)</span><span class="se">\t</span><span class="s2">Module - Recording the message:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NODE_METRIC</span>

                            <span class="n">service_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__update_node_metrics</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>

                            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">service_time</span><span class="p">)</span>
                            <span class="n">doBefore</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        Transferring the message</span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">register</span><span class="p">[</span><span class="s2">&quot;message_out&quot;</span><span class="p">]:</span>
                            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                            Sink behaviour (nothing to send)</span>
<span class="sd">                            &quot;&quot;&quot;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;(App:</span><span class="si">%s</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">#</span><span class="si">%s</span><span class="s2">)</span><span class="se">\t</span><span class="s2">Module - Sink Message:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">register</span><span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">](</span><span class="o">**</span><span class="n">register</span><span class="p">[</span><span class="s2">&quot;param&quot;</span><span class="p">]):</span> <span class="c1">### THRESHOLD DISTRIBUTION to Accept the message from source</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">register</span><span class="p">[</span><span class="s2">&quot;module_dest&quot;</span><span class="p">]:</span>
                                    <span class="c1"># it is not a broadcasting message</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(App:</span><span class="si">%s</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">#</span><span class="si">%s</span><span class="s2">)</span><span class="se">\t</span><span class="s2">Module - Transmit Message:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">app_name</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">register</span><span class="p">[</span><span class="s2">&quot;message_out&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

                                    <span class="n">msg_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">register</span><span class="p">[</span><span class="s2">&quot;message_out&quot;</span><span class="p">])</span>
                                    <span class="n">msg_out</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                                    <span class="n">msg_out</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">id</span>
                                    <span class="n">msg_out</span><span class="o">.</span><span class="n">last_idDes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">last_idDes</span><span class="p">)</span>
                                    <span class="n">msg_out</span><span class="o">.</span><span class="n">last_idDes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ides</span><span class="p">)</span>


                                    <span class="bp">self</span><span class="o">.</span><span class="n">__send_message</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">msg_out</span><span class="p">,</span><span class="n">ides</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FORWARD_METRIC</span><span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># it is a broadcasting message</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(App:</span><span class="si">%s</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">#</span><span class="si">%s</span><span class="s2">)</span><span class="se">\t</span><span class="s2">Module - Broadcasting Message:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">app_name</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">register</span><span class="p">[</span><span class="s2">&quot;message_out&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

                                    <span class="n">msg_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">register</span><span class="p">[</span><span class="s2">&quot;message_out&quot;</span><span class="p">])</span>
                                    <span class="n">msg_out</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
                                    <span class="n">msg_out</span><span class="o">.</span><span class="n">last_idDes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">last_idDes</span><span class="p">)</span>
                                    <span class="n">msg_out</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">id</span>
                                    <span class="n">msg_out</span><span class="o">.</span><span class="n">last_idDes</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">last_idDes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ides</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">module_dst</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">register</span><span class="p">[</span><span class="s2">&quot;module_dest&quot;</span><span class="p">]):</span>
                                        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">register</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">__send_message</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">msg_out</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">FORWARD_METRIC</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(App:</span><span class="si">%s</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">#</span><span class="si">%s</span><span class="s2">)</span><span class="se">\t</span><span class="s2">Module - Stopped Message:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">app_name</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">register</span><span class="p">[</span><span class="s2">&quot;message_out&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOP_Process - Module Consumer: </span><span class="si">%s</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ides</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__add_sink_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It generates a DES process associated to a SINK module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added_Process - Module Pure Sink: </span><span class="si">%s</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ides</span><span class="p">))</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">ides</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">consumer_pipes</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s%s%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">ides</span><span class="p">)]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Processing the message</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;(App:</span><span class="si">%s</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">#</span><span class="si">%s</span><span class="s2">)</span><span class="se">\t</span><span class="s2">Module Pure - Sink Message:</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SINK_METRIC</span>
            <span class="n">service_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__update_node_metrics</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">ides</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">service_time</span><span class="p">)</span>  <span class="c1"># service time is 0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOP_Process - Module Pure Sink: </span><span class="si">%s</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">ides</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__add_stop_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">distribution</span><span class="p">,</span><span class="n">show_progress_monitor</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a DES process for Stop/Progress bar monitor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">myId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added_Process - Internal Monitor: </span><span class="si">%s</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">myId</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">show_progress_monitor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">until</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">distribution</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
            <span class="n">function</span><span class="p">(</span><span class="n">show_progress_monitor</span><span class="p">,</span><span class="o">**</span><span class="n">param</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOP_Process - Internal Monitor: </span><span class="si">%s</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">myId</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__add_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">distribution</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a DES process for user purpose</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">myId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added_Process - Internal Monitor: </span><span class="si">%s</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">myId</span><span class="p">))</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">distribution</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
            <span class="n">function</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;STOP_Process - Internal Monitor: </span><span class="si">%s</span><span class="se">\t</span><span class="s2">#DES:</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">myId</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__add_consumer_service_pipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">app_name</span><span class="p">,</span><span class="n">module</span><span class="p">,</span><span class="n">idDES</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating PIPE: </span><span class="si">%s%s%i</span><span class="s2"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span><span class="n">module</span><span class="p">,</span><span class="n">idDES</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">consumer_pipes</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s%s%i</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span><span class="n">module</span><span class="p">,</span><span class="n">idDES</span><span class="p">)]</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">__ctrl_progress_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">show_progress_monitor</span><span class="p">,</span><span class="n">time_shift</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The *simpy.run.until* function doesnot stop the execution until all pipes are empty.</span>
<span class="sd">        We force the stop our DES process using *self.stop* boolean</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">until</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">show_progress_monitor</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">time_shift</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">until</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">show_progress_monitor</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;! Stop simulation at time: </span><span class="si">%f</span><span class="s2"> !&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPRECATED</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__update_internal_structures_from_DES_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DES</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">DES</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">DES</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kc">None</span>


    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SECTION FOR PUBLIC METHODS</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Sim.get_DES"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.get_DES">[docs]</a>    <span class="k">def</span> <span class="nf">get_DES</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_control_process</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

<div class="viewcode-block" id="Sim.deploy_monitor"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.deploy_monitor">[docs]</a>    <span class="k">def</span> <span class="nf">deploy_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">distribution</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a DES process for user purpose</span>

<span class="sd">        Args:</span>
<span class="sd">            name (string) name of monitor</span>

<span class="sd">            function (function): function that will be invoked within the simulator with the user&#39;s code</span>

<span class="sd">            distribution (function): a temporary distribution function</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            param (dict): the parameters of the *distribution* function</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_monitor</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">distribution</span><span class="p">,</span> <span class="o">**</span><span class="n">param</span><span class="p">))</span></div>

<div class="viewcode-block" id="Sim.register_event_entity"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.register_event_entity">[docs]</a>    <span class="k">def</span> <span class="nf">register_event_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_event_dist</span><span class="p">,</span> <span class="n">event_type</span><span class="o">=</span><span class="n">EVENT_UP_ENTITY</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event_type</span> <span class="o">==</span> <span class="n">EVENT_UP_ENTITY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_up_node_process</span><span class="p">(</span> <span class="n">next_event_dist</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">event_type</span> <span class="o">==</span> <span class="n">EVENT_DOWN_ENTITY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_down_node_process</span><span class="p">(</span> <span class="n">next_event_dist</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">))</span></div>

<div class="viewcode-block" id="Sim.deploy_source"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.deploy_source">[docs]</a>    <span class="k">def</span> <span class="nf">deploy_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">id_node</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">distribution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a DES process for deploy pure source modules (sensors)</span>
<span class="sd">        This function its used by (:mod:`Population`) algorithm</span>

<span class="sd">        Args:</span>
<span class="sd">            app_name (str): application name</span>

<span class="sd">            id_node (int): entity.id of the topology who will create the messages</span>

<span class="sd">            distribution (function): a temporary distribution function</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            param - the parameters of the *distribution* function</span>

<span class="sd">        Returns:</span>
<span class="sd">            id (int) the same input *id*</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idDES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">idDES</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_source_population</span><span class="p">(</span><span class="n">idDES</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">distribution</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">idDES</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_source</span><span class="p">[</span><span class="n">idDES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="n">id_node</span><span class="p">,</span><span class="s2">&quot;app&quot;</span><span class="p">:</span><span class="n">app_name</span><span class="p">,</span><span class="s2">&quot;module&quot;</span><span class="p">:</span><span class="n">msg</span><span class="o">.</span><span class="n">src</span><span class="p">,</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="n">msg</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">idDES</span></div>



    <span class="k">def</span> <span class="nf">__deploy_source_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">id_node</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">distribution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a DES process for deploy  source modules</span>
<span class="sd">        This function its used by (:mod:`Population`) algorithm</span>

<span class="sd">        Args:</span>
<span class="sd">            app_name (str): application name</span>

<span class="sd">            id_node (int): entity.id of the topology who will create the messages</span>

<span class="sd">            distribution (function): a temporary distribution function</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            param - the parameters of the *distribution* function</span>

<span class="sd">        Returns:</span>
<span class="sd">            id (int) the same input *id*</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idDES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">idDES</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_source_module</span><span class="p">(</span><span class="n">idDES</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span> <span class="n">distribution</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">idDES</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_node</span>
        <span class="k">return</span> <span class="n">idDES</span>

    <span class="c1"># idsrc = sim.deploy_module(app_name, module, id_node, register_consumer_msg)</span>
    <span class="k">def</span> <span class="nf">__deploy_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">id_node</span><span class="p">,</span> <span class="n">register_consumer_msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a DES process for deploy  modules</span>
<span class="sd">        This function its used by (:mod:`Population`) algorithm</span>

<span class="sd">        Args:</span>
<span class="sd">            app_name (str): application name</span>

<span class="sd">            id_node (int): entity.id of the topology who will create the messages</span>

<span class="sd">            module (str): module name</span>

<span class="sd">            msg (str): message?</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            param - the parameters of the *distribution* function</span>

<span class="sd">        Returns:</span>
<span class="sd">            id (int) the same input *id*</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idDES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">idDES</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_consumer_module</span><span class="p">(</span><span class="n">idDES</span><span class="p">,</span><span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span><span class="n">register_consumer_msg</span><span class="p">))</span>
        <span class="c1"># To generate the QUEUE of a SERVICE module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_consumer_service_pipe</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">idDES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">idDES</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_node</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app_name</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app_name</span><span class="p">][</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app_name</span><span class="p">][</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idDES</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">idDES</span>


<div class="viewcode-block" id="Sim.deploy_sink"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.deploy_sink">[docs]</a>    <span class="k">def</span> <span class="nf">deploy_sink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a DES process for deploy pure SINK modules (actuators)</span>
<span class="sd">        This function its used by (:mod:`Placement`): algorithm</span>
<span class="sd">        Internatlly, there is not a DES PROCESS for this type of behaviour</span>

<span class="sd">        Args:</span>
<span class="sd">            app_name (str): application name</span>

<span class="sd">            node (int): entity.id of the topology who will create the messages</span>

<span class="sd">            module (str): module</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idDES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">idDES</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">idDES</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_consumer_service_pipe</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">idDES</span><span class="p">)</span>
        <span class="c1"># Update the relathionships among module-entity</span>
        <span class="k">if</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app_name</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app_name</span><span class="p">][</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app_name</span><span class="p">][</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idDES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_sink_module</span><span class="p">(</span><span class="n">idDES</span><span class="p">,</span><span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">))</span></div>



<div class="viewcode-block" id="Sim.stop_process"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.stop_process">[docs]</a>    <span class="k">def</span> <span class="nf">stop_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All pure source modules (sensors) are controlled by this boolean.</span>
<span class="sd">        Using this function (:mod:`Population`) algorithm can stop one source</span>

<span class="sd">        Args:</span>
<span class="sd">            id.source (int): the identifier of the DES process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Sim.start_process"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.start_process">[docs]</a>    <span class="k">def</span> <span class="nf">start_process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All pure source modules (sensors) are controlled by this boolean.</span>
<span class="sd">        Using this function (:mod:`Population`) algorithm can start one source</span>

<span class="sd">        Args:</span>
<span class="sd">            id.source (int): the identifier of the DES process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="Sim.deploy_app"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.deploy_app">[docs]</a>    <span class="k">def</span> <span class="nf">deploy_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">placement</span><span class="p">,</span> <span class="n">population</span><span class="p">,</span> <span class="n">selector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This process is responsible for linking the *application* to the different algorithms (placement, population, and service)</span>

<span class="sd">        Args:</span>
<span class="sd">            app (object): :mod:`Application` class</span>

<span class="sd">            placement (object): :mod:`Placement` class</span>

<span class="sd">            population (object): :mod:`Population` class</span>

<span class="sd">            selector (object): :mod:`Selector` class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">[</span><span class="n">app</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span>

        <span class="c1"># Initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Add Placement controls to the App</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">placement</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">placement_policy</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># First Time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">placement_policy</span><span class="p">[</span><span class="n">placement</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;placement_policy&quot;</span><span class="p">:</span> <span class="n">placement</span><span class="p">,</span> <span class="s2">&quot;apps&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">if</span> <span class="n">placement</span><span class="o">.</span><span class="n">activation_dist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_placement_process</span><span class="p">(</span><span class="n">placement</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">placement_policy</span><span class="p">[</span><span class="n">placement</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;apps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Add Population control to the App</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">population</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">population_policy</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># First Time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">population_policy</span><span class="p">[</span><span class="n">population</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;population_policy&quot;</span><span class="p">:</span> <span class="n">population</span><span class="p">,</span> <span class="s2">&quot;apps&quot;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">if</span> <span class="n">population</span><span class="o">.</span><span class="n">activation_dist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_population_process</span><span class="p">(</span><span class="n">population</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">population_policy</span><span class="p">[</span><span class="n">population</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;apps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Add Selection control to the App</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selector_path</span><span class="p">[</span><span class="n">app</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span></div>


<div class="viewcode-block" id="Sim.get_alloc_entities"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.get_alloc_entities">[docs]</a>    <span class="k">def</span> <span class="nf">get_alloc_entities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; It returns a dictionary of deployed services</span>
<span class="sd">        key : id-node</span>
<span class="sd">        value: a list of deployed services</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alloc_entities</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">alloc_entities</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>


        <span class="k">for</span> <span class="n">id_des_process</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_source</span><span class="p">:</span>
            <span class="n">src_deployed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_source</span><span class="p">[</span><span class="n">id_des_process</span><span class="p">]</span>
            <span class="c1"># print &quot;Module (SRC): %s(%s) - deployed at entity.id: %s&quot; %(src_deployed[&quot;module&quot;],src_deployed[&quot;app&quot;],src_deployed[&quot;id&quot;])</span>
            <span class="n">alloc_entities</span><span class="p">[</span><span class="n">src_deployed</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src_deployed</span><span class="p">[</span><span class="s2">&quot;app&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="n">src_deployed</span><span class="p">[</span><span class="s2">&quot;module&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app</span><span class="p">]:</span>
                <span class="c1"># print &quot;Module (MOD): %s(%s) - deployed at entities.id: %s&quot; % (module,app,self.alloc_module[app][module])</span>
                <span class="k">for</span> <span class="n">idDES</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">module</span><span class="p">]:</span>
                    <span class="n">alloc_entities</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">idDES</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="o">+</span><span class="s2">&quot;#&quot;</span><span class="o">+</span><span class="n">module</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">alloc_entities</span></div>


<div class="viewcode-block" id="Sim.deploy_module"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.deploy_module">[docs]</a>    <span class="k">def</span> <span class="nf">deploy_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">app_name</span><span class="p">,</span><span class="n">module</span><span class="p">,</span> <span class="n">services</span><span class="p">,</span><span class="n">ids</span><span class="p">):</span>
        <span class="n">register_consumer_msg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">id_DES</span> <span class="o">=</span><span class="p">[]</span>

        <span class="c1"># print module</span>
        <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            A module can manage multiples messages as well as pass them as create them.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">service</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Application</span><span class="o">.</span><span class="n">TYPE_SOURCE</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                The MODULE can generate messages according with a distribution:</span>
<span class="sd">                It adds a DES process for mananging it:  __add_source_module</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">for</span> <span class="n">id_topology</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="n">id_DES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__deploy_source_module</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="n">service</span><span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">],</span>
                                                     <span class="n">msg</span><span class="o">=</span><span class="n">service</span><span class="p">[</span><span class="s2">&quot;message_out&quot;</span><span class="p">],</span>
                                                     <span class="n">id_node</span><span class="o">=</span><span class="n">id_topology</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                The MODULE can deal with different messages, &quot;tuppleMapping (iFogSim)&quot;,</span>
<span class="sd">                all of them are add a list to be managed in only one DES process</span>
<span class="sd">                MODULE TYPE CONSUMER : adding process:  __add_consumer_module</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># 1 module puede consumir N type de messages con diferentes funciones de distribucion</span>
                <span class="n">register_consumer_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;message_in&quot;</span><span class="p">:</span> <span class="n">service</span><span class="p">[</span><span class="s2">&quot;message_in&quot;</span><span class="p">],</span> <span class="s2">&quot;message_out&quot;</span><span class="p">:</span> <span class="n">service</span><span class="p">[</span><span class="s2">&quot;message_out&quot;</span><span class="p">],</span>
                     <span class="s2">&quot;module_dest&quot;</span><span class="p">:</span> <span class="n">service</span><span class="p">[</span><span class="s2">&quot;module_dest&quot;</span><span class="p">],</span> <span class="s2">&quot;dist&quot;</span><span class="p">:</span> <span class="n">service</span><span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">],</span> <span class="s2">&quot;param&quot;</span><span class="p">:</span> <span class="n">service</span><span class="p">[</span><span class="s2">&quot;param&quot;</span><span class="p">]})</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">register_consumer_msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">id_topology</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">id_DES</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__deploy_module</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">id_topology</span><span class="p">,</span> <span class="n">register_consumer_msg</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">id_DES</span></div>


<div class="viewcode-block" id="Sim.undeploy_module"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.undeploy_module">[docs]</a>    <span class="k">def</span> <span class="nf">undeploy_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span><span class="n">service_name</span><span class="p">,</span> <span class="n">idtopo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; removes all modules deployed in a node</span>
<span class="sd">        modules with the same name = service_name</span>
<span class="sd">        from app_name</span>
<span class="sd">        deployed in id_topo</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_des</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">idtopo</span><span class="p">:</span>
                <span class="n">all_des</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="c1"># Clearing related structures</span>
        <span class="k">for</span> <span class="n">des</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app_name</span><span class="p">][</span><span class="n">service_name</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">des</span> <span class="ow">in</span> <span class="n">all_des</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app_name</span><span class="p">][</span><span class="n">service_name</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">des</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_process</span><span class="p">(</span><span class="n">des</span><span class="p">)</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">des</span><span class="p">]</span></div>

<div class="viewcode-block" id="Sim.remove_node"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.remove_node">[docs]</a>    <span class="k">def</span> <span class="nf">remove_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_node_topology</span><span class="p">):</span>
        <span class="c1"># Stopping related processes deployed in the module and clearing main structure: alloc_DES</span>
        <span class="n">des_tmp</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="n">id_node_topology</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">id_node_topology</span><span class="p">:</span>
                    <span class="n">des_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stop_process</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="c1"># Clearing other related structures</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k2</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">des_tmp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v2</span><span class="p">:</span>
                        <span class="n">v2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Finally removing node from topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">id_node_topology</span><span class="p">)</span></div>

<div class="viewcode-block" id="Sim.draw_allocated_topology"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.draw_allocated_topology">[docs]</a>    <span class="k">def</span> <span class="nf">draw_allocated_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alloc_entities</span><span class="p">()</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">draw_topology</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">,</span><span class="n">entities</span><span class="p">)</span></div>


<div class="viewcode-block" id="Sim.get_DES_from_Service_In_Node"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.get_DES_from_Service_In_Node">[docs]</a>    <span class="k">def</span> <span class="nf">get_DES_from_Service_In_Node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">service</span><span class="p">):</span>
        <span class="n">deployed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app_name</span><span class="p">][</span><span class="n">service</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">des</span> <span class="ow">in</span> <span class="n">deployed</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">des</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">des</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="Sim.get_assigned_structured_modules_from_DES"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.get_assigned_structured_modules_from_DES">[docs]</a>    <span class="k">def</span> <span class="nf">get_assigned_structured_modules_from_DES</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fullAssignation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app</span><span class="p">]:</span>
                <span class="n">deployed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">module</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">des</span> <span class="ow">in</span> <span class="n">deployed</span><span class="p">:</span>
                    <span class="n">fullAssignation</span><span class="p">[</span><span class="n">des</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;DES&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">des</span><span class="p">],</span> <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">module</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">fullAssignation</span></div>


<div class="viewcode-block" id="Sim.print_debug_assignaments"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.print_debug_assignaments">[docs]</a>    <span class="k">def</span> <span class="nf">print_debug_assignaments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This functions prints debug information about the assignment of DES process - Topology ID - Source Module or Modules</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fullAssignation</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app</span><span class="p">]:</span>
                <span class="n">deployed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_module</span><span class="p">[</span><span class="n">app</span><span class="p">][</span><span class="n">module</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">des</span> <span class="ow">in</span> <span class="n">deployed</span><span class="p">:</span>
                    <span class="n">fullAssignation</span><span class="p">[</span><span class="n">des</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ID&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">des</span><span class="p">],</span><span class="s2">&quot;Module&quot;</span><span class="p">:</span><span class="n">module</span><span class="p">}</span> <span class="c1">#DES process are unique for each module/element</span>

        <span class="nb">print</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">40</span>
        <span class="nb">print</span> <span class="s2">&quot;DES</span><span class="se">\t</span><span class="s2">| TOPO </span><span class="se">\t</span><span class="s2">| Src.Mod </span><span class="se">\t</span><span class="s2">| Modules&quot;</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">k</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">|&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">alloc_DES</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">|&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">alloc_source</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alloc_source</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">|&quot;</span><span class="p">,</span><span class="n">fullAssignation</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;Module&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">fullAssignation</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;--&quot;</span>
        <span class="nb">print</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span></div>
        <span class="c1"># exit()</span>

    <span class="c1">#</span>
    <span class="c1"># ### MOBILE ADAPTATION SECTION</span>
    <span class="c1"># def update_service_coverage(self):</span>
    <span class="c1">#     if self.street_network is not None:</span>
    <span class="c1">#         points = utils.create_points(self.topology.G)</span>
    <span class="c1">#         point_streets = utils.create_points(self.street_network)</span>
    <span class="c1">#</span>
    <span class="c1">#         tree = scipy.spatial.KDTree(points.values())</span>
    <span class="c1">#         points_within_tolerance = tree.query_ball_point(point_streets.values(), self.tolerance)</span>
    <span class="c1">#</span>
    <span class="c1">#         # key = node network</span>
    <span class="c1">#         # value = id - module SW</span>
    <span class="c1">#</span>
    <span class="c1">#         self.service_coverage = {}</span>
    <span class="c1">#         for idx, pt in enumerate(points_within_tolerance):</span>
    <span class="c1">#             ## MODULE SW</span>
    <span class="c1">#             key2 = point_streets.keys()[idx]</span>
    <span class="c1">#             nG2 = self.street_network.nodes[key2]</span>
    <span class="c1">#             # print &quot;%s is close to &quot; % nG2[&quot;model&quot;]</span>
    <span class="c1">#             ## Street coverage</span>
    <span class="c1">#             for p in pt:</span>
    <span class="c1">#                 key = points.keys()[p]</span>
    <span class="c1">#                 # service_coverage[(G.nodes[key][&#39;x&#39;],G.nodes[key][&#39;y&#39;])]=nG2[&quot;model&quot;]</span>
    <span class="c1">#                 self.service_coverage[key] = nG2[&quot;id&quot;]</span>



    <span class="c1"># def setMobilityUserBehaviour(self,dataPopulation):</span>
    <span class="c1">#     self.user_behaviour = dataPopulation #TODO CHECK SYNTAX</span>

    <span class="k">def</span> <span class="nf">__add_mobile_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ides</span><span class="p">,</span> <span class="n">gme</span><span class="p">):</span>
        <span class="c1">#The mobile starts</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">gme</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(#DES:</span><span class="si">%i</span><span class="s2">)</span><span class="se">\t</span><span class="s2">--- Mobile Entity STARTS :</span><span class="se">\t</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ides</span><span class="p">,</span> <span class="n">gme</span><span class="o">.</span><span class="n">_id</span><span class="p">))</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gme</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">gme</span><span class="o">.</span><span class="n">current_position</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">ides</span><span class="p">]:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">gme</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">gme</span><span class="o">.</span><span class="n">current_position</span><span class="p">],</span> <span class="n">gme</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="n">gme</span><span class="o">.</span><span class="n">current_position</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">street_network</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">next_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">toMeters</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">gme</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">next_time</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># default time by roundabout or other Spatial THINGS</span>

            <span class="c1"># take an action?</span>
            <span class="n">gme</span><span class="o">.</span><span class="n">next_time</span> <span class="o">=</span> <span class="n">next_time</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(#DES:</span><span class="si">%i</span><span class="s2">)</span><span class="se">\t</span><span class="s2">--- DO ACTION :</span><span class="se">\t</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ides</span><span class="p">,</span> <span class="n">gme</span><span class="o">.</span><span class="n">_id</span><span class="p">))</span>
            <span class="n">gme</span><span class="o">.</span><span class="n">do</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">gme</span><span class="p">)</span>

            <span class="c1">#TODO Can the MA wait more time in that node?</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">next_time</span><span class="p">)</span>
            <span class="n">gme</span><span class="o">.</span><span class="n">current_position</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Last movement</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">ides</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">:</span>
            <span class="n">gme</span><span class="o">.</span><span class="n">do</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">gme</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(#DES:</span><span class="si">%i</span><span class="s2">)</span><span class="se">\t</span><span class="s2">--- Mobile Entity ENDS :</span><span class="se">\t</span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ides</span><span class="p">,</span> <span class="n">gme</span><span class="o">.</span><span class="n">_id</span><span class="p">))</span>
        <span class="c1"># print &quot;Mobile agent: %s ends &quot; % gme.plate</span>



<div class="viewcode-block" id="Sim.add_mobile_agent"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.add_mobile_agent">[docs]</a>    <span class="k">def</span> <span class="nf">add_mobile_agent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gme</span><span class="p">):</span>
        <span class="n">ides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_id_process</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">des_process_running</span><span class="p">[</span><span class="n">ides</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_mobile_agent</span><span class="p">(</span><span class="n">ides</span><span class="p">,</span> <span class="n">gme</span><span class="p">))</span>

        <span class="c1">### ATENCION COONTROLAR VAR: INTERNAS</span>
        <span class="c1">#self.alloc_DES[ides] = id_node</span>

        <span class="k">return</span> <span class="n">ides</span></div>

<div class="viewcode-block" id="Sim.load_user_tracks"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.load_user_tracks">[docs]</a>    <span class="k">def</span> <span class="nf">load_user_tracks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tracks</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_tracks</span> <span class="o">=</span> <span class="n">tracks</span></div>

        <span class="c1"># self.user_tracks = AnimationTrack(df_points=tracks, dpi=300, bg_map=False, map_transparency=0.5)</span>

        <span class="c1"># for i, (point, nextpoint) in enumerate(fig.compute_points()):</span>
        <span class="c1">#     print i, point, nextpoint</span>
        <span class="c1">#     if i == 2: break</span>
        <span class="c1"># exit()</span>

<div class="viewcode-block" id="Sim.generate_animation"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.generate_animation">[docs]</a>    <span class="k">def</span> <span class="nf">generate_animation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pathFile</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__update_connection_points</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_map</span><span class="p">()</span>

        <span class="c1">#map_endpoints = [self.map.to_pixels(i[0], i[1]) for i in self.endpoints]</span>
        <span class="c1">#map_endpoints = np.array(map_endpoints)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pathFile</span><span class="o">+</span><span class="s2">&quot;_map_background.png&quot;</span><span class="p">)</span>

        <span class="n">animation</span> <span class="o">=</span> <span class="n">AnimationTrack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">bg_map</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
        <span class="n">animation</span><span class="o">.</span><span class="n">make_video</span><span class="p">(</span><span class="n">output_file</span><span class="o">=</span><span class="n">pathFile</span><span class="p">,</span> <span class="n">framerate</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">G</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">G</span><span class="p">)</span></div>


    <span class="c1"># def generate_snapshot(self, pathFile,event):</span>
    <span class="c1">#     if len(self.endpoints) == 0: self.__update_connection_points()</span>
    <span class="c1">#     if self.map == None: self.__load_map()</span>
    <span class="c1">#</span>
    <span class="c1">#     #map_endpoints = [self.map.to_pixels(i[0], i[1]) for i in self.endpoints]</span>
    <span class="c1">#     #map_endpoints = np.array(map_endpoints)</span>
    <span class="c1">#</span>
    <span class="c1">#     animation = AnimationTrack(self, dpi=100, bg_map=True, aspect=&#39;equal&#39;)</span>
    <span class="c1">#     animation.make_video(output_file=pathFile, framerate=10, linewidth=1.0)</span>

    <span class="k">def</span> <span class="nf">__load_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">trk_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_tracks</span><span class="o">.</span><span class="n">get_bounds</span><span class="p">()</span>
        <span class="n">min_lat</span> <span class="o">=</span> <span class="n">trk_bounds</span><span class="o">.</span><span class="n">min_latitude</span>
        <span class="n">max_lat</span> <span class="o">=</span> <span class="n">trk_bounds</span><span class="o">.</span><span class="n">max_latitude</span>
        <span class="n">min_lng</span> <span class="o">=</span> <span class="n">trk_bounds</span><span class="o">.</span><span class="n">min_longitude</span>
        <span class="n">max_lng</span> <span class="o">=</span> <span class="n">trk_bounds</span><span class="o">.</span><span class="n">max_longitude</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">smopy</span><span class="o">.</span><span class="n">Map</span><span class="p">((</span><span class="n">min_lat</span><span class="p">,</span> <span class="n">min_lng</span><span class="p">,</span> <span class="n">max_lat</span><span class="p">,</span> <span class="n">max_lng</span><span class="p">),</span> <span class="n">z</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__update_connection_points</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">)</span>
        <span class="n">lng</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;lng&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_endpoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">level</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lat</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">lng</span><span class="p">[</span><span class="n">n</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name_endpoints</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">=</span><span class="n">n</span>
                <span class="n">pos</span> <span class="o">+=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span><span class="p">)</span>


<div class="viewcode-block" id="Sim.set_coverage_class"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.set_coverage_class">[docs]</a>    <span class="k">def</span> <span class="nf">set_coverage_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_name</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__update_connection_points</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_map</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coverage</span> <span class="o">=</span> <span class="n">class_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoints</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Sim.set_mobile_fog_entities"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.set_mobile_fog_entities">[docs]</a>    <span class="k">def</span> <span class="nf">set_mobile_fog_entities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mobile_fog_entities</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mobile_fog_entities</span> <span class="o">=</span> <span class="n">mobile_fog_entities</span></div>

<div class="viewcode-block" id="Sim.set_movement_control"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.set_movement_control">[docs]</a>    <span class="k">def</span> <span class="nf">set_movement_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">evol</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_movement_class</span> <span class="o">=</span> <span class="n">evol</span></div>

<div class="viewcode-block" id="Sim.run"><a class="viewcode-back" href="../../api_reference/yafs.html#yafs.core.Sim.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">until</span><span class="p">,</span><span class="n">test_initial_deploy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">show_progress_monitor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mobile_behaviour</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the simulation</span>

<span class="sd">        Args:</span>
<span class="sd">            until (int): Defines a stop time. If None the simulation runs until some internal algorithm changes the var *yafs.core.sim.stop* to True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__network_process</span><span class="p">())</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creating app.sources and deploy the sources in the topology</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">population_policy</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="n">pop</span><span class="p">[</span><span class="s2">&quot;apps&quot;</span><span class="p">]:</span>
                <span class="n">pop</span><span class="p">[</span><span class="s2">&quot;population_policy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">initial_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creating initial deploy of services</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">placement_policy</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="n">place</span><span class="p">[</span><span class="s2">&quot;apps&quot;</span><span class="p">]:</span>

                <span class="nb">print</span> <span class="s2">&quot;APP_NAME &quot;</span><span class="p">,</span><span class="n">app_name</span>
                <span class="n">place</span><span class="p">[</span><span class="s2">&quot;placement_policy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">initial_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">)</span>  <span class="c1"># internally consideres the apps in charge</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A internal DES process will stop the simulation,</span>
<span class="sd">        *Simpy.run.until* wait to all pipers are empty. So, hundreds of messages should be service... We force with the stop</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_shift</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">deterministic_distribution</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;SIM_Deterministic&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time_shift</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__add_stop_monitor</span><span class="p">(</span><span class="s2">&quot;Stop_Control_Monitor&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__ctrl_progress_monitor</span><span class="p">,</span><span class="n">distribution</span><span class="p">,</span><span class="n">show_progress_monitor</span><span class="p">,</span><span class="n">time_shift</span><span class="o">=</span><span class="n">time_shift</span><span class="p">))</span>

        <span class="c1"># if mobile_behaviour:</span>
        <span class="c1">#     &quot;&quot;&quot;</span>
        <span class="c1">#     Updating control variables of mobile environment</span>
        <span class="c1">#     &quot;&quot;&quot;</span>
        <span class="c1">#     self.update_service_coverage()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">print_debug_assignaments</span><span class="p">()</span>


        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        RUN</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">until</span> <span class="o">=</span> <span class="n">until</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_initial_deploy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="n">until</span><span class="p">)</span> <span class="c1">#This does not stop the simpy.simulation at time. We have to force the stop</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../contents.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">OVERVIEW</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../index.html#acknowledge">Acknowledge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">YAFS in 5 Minutes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../architecture/index.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/index.html">API REFERENCE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">ABOUT</a></li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../contents.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Isaac Lera, Carlos Guerrero.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>